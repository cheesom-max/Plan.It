<!-- Integrated Itinerary Dashboard -->
<!DOCTYPE html>
<html class="light" lang="ko">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KESMY9MVTT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-KESMY9MVTT');
    </script>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>통합 일정 대시보드 - VoyageAI</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=Noto+Sans+KR:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "sans": ["Noto Sans KR", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body { font-family: 'Noto Sans KR', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
    <!-- Leaflet Map CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-[#0d141b] dark:text-slate-100 transition-colors duration-200">
    <div class="flex h-screen flex-col overflow-hidden">
        <header
            class="flex items-center justify-between border-b border-[#e7edf3] dark:border-slate-800 bg-white dark:bg-background-dark px-6 py-3 shrink-0 z-10">
            <div class="flex items-center gap-8 cursor-pointer" onclick="location.href='index.html'">
                <div class="flex items-center gap-3">
                    <div class="bg-primary text-white p-1.5 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-2xl">auto_awesome</span>
                    </div>
                    <h2 class="text-xl font-bold tracking-tight">VoyageAI</h2>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <nav class="hidden md:flex items-center gap-6 text-sm font-medium">
                    <a class="text-primary border-b-2 border-primary pb-1" href="#">일정</a>
                    <a class="text-[#4c739a] hover:text-primary transition-colors" href="profile.html">보관함</a>
                </nav>
                <div class="flex gap-2">
                    <button id="saveItineraryBtn"
                        class="bg-[#e7edf3] dark:bg-slate-800 text-[#0d141b] dark:text-slate-200 px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-200">저장하기</button>
                    <button
                        class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        공유하기
                    </button>
                </div>

                <!-- Auth UI -->
                <div id="authButtons">
                    <button id="loginBtn" class="text-sm font-bold text-gray-700 hover:text-primary">로그인</button>
                </div>
                <div id="userProfile" style="display: none;" class="flex items-center gap-3">
                    <div id="userAvatar"
                        class="size-9 rounded-full bg-cover bg-center border-2 border-primary/20 user-avatar-display"
                        style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuDUbRi1dNmazqody33qD6TTCWydDsTwSDqtD_Pks0o9P2NnjcNATN_5nJvkht0zUcufLJnm8q8uVVJt91FkmqbIBo-1kCWmzegCjCmmLsQ1p6WNp_Bto5mgU36KhcTZQM30GxD5fsdDRZ11D40VVdqR-QV3Rlfcju_eOtSga9KkNPtv1U5QzTdbeUcOeMhMli5Vonaad383spoJCqCm9AXACWSLb19MDd4EIYdzszf43WRTrgjEUOv8FWUezknlXfyQ-rhj-eVgy-g');">
                    </div>
                    <button id="logoutBtn" class="text-xs text-gray-500 hover:text-primary">로그아웃</button>
                </div>
            </div>
        </header>
        <main class="flex flex-1 overflow-hidden">
            <aside
                class="w-72 border-r border-[#e7edf3] dark:border-slate-800 bg-white dark:bg-background-dark flex flex-col shrink-0">
                <div class="p-4 flex-1 overflow-y-auto no-scrollbar">
                    <div class="mb-6">
                        <h3 class="text-xs font-bold uppercase tracking-widest text-[#4c739a] mb-4">여행 일정</h3>
                        <div class="space-y-1" id="daySidebarList">
                            <!-- Dynamic list -->
                            <p class="text-xs text-gray-400 p-2">일정을 불러오는 중...</p>
                        </div>
                    </div>
                    <div class="mt-auto pt-6 border-t border-[#e7edf3] dark:border-slate-800">
                        <div class="bg-background-light dark:bg-slate-800/50 p-4 rounded-xl">
                            <div class="flex items-center justify-between mb-4">
                                <p class="text-sm font-bold">예산 요약 (일평균)</p>
                                <span class="material-symbols-outlined text-primary text-lg">monetization_on</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div>
                                    <p class="text-lg font-bold leading-tight" id="estimatedCost">₩0</p>
                                    <p class="text-[10px] text-[#4c739a] uppercase tracking-wider font-bold">총 예상 지출</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>
            <section
                class="flex-1 bg-background-light dark:bg-background-dark overflow-y-auto no-scrollbar border-r border-[#e7edf3] dark:border-slate-800"
                id="mainContentScroll">
                <div class="max-w-2xl mx-auto px-6 py-8" id="itineraryContent">
                    <!-- Dynamic Content -->
                    <div class="text-center py-20">
                        <h2 class="text-2xl font-bold mb-2">일정을 생성 중이거나 불러오는 중입니다...</h2>
                        <p class="text-gray-500">잠시만 기다려주세요.</p>
                    </div>
                </div>
            </section>

            <!-- Map Section -->
            <section
                class="w-[450px] bg-slate-100 dark:bg-slate-900 shrink-0 relative hidden lg:block border-l border-[#e7edf3] dark:border-slate-800">
                <div id="map" class="w-full h-full z-0"></div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    <script src="auth-ui.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Load Itinerary Data
            const itineraryData = localStorage.getItem('travelItinerary');
            const tripInfo = localStorage.getItem('tripInfo');

            if (!itineraryData) {
                document.getElementById('itineraryContent').innerHTML = `
                    <div class="text-center py-20">
                         <h2 class="text-2xl font-bold mb-2">생성된 일정이 없습니다.</h2>
                         <button class="text-primary hover:underline" onclick="location.href='create.html'">일정 만들기</button>
                    </div>
                 `;
                return;
            }

            try {
                const itinerary = JSON.parse(itineraryData);
                renderItinerary(itinerary);

                // Initialize Map
                if (tripInfo) {
                    const info = JSON.parse(tripInfo);
                    if (info.destinations && info.destinations.length > 0) {
                        initMap(info.destinations[0]);
                    }
                }
            } catch (e) {
                console.error('Data parse error', e);
            }

            // Save Button Logic
            const saveBtn = document.getElementById('saveItineraryBtn');
            saveBtn.addEventListener('click', async () => {
                if (!window.Auth) return;
                const session = await window.Auth.getSession();
                if (!session || !session.user) {
                    if (confirm('로그인이 필요합니다. 로그인하시겠습니까?')) {
                        window.location.href = 'index.html?action=login'; // Auth logic in index handles parameter? or show modal
                    }
                    return;
                }

                // Save Logic Implementation
                saveBtn.textContent = '저장 중...';
                saveBtn.disabled = true;

                try {
                    const itinerary = JSON.parse(localStorage.getItem('travelItinerary'));
                    const tripInfo = JSON.parse(localStorage.getItem('tripInfo'));

                    if (!itinerary || !tripInfo) throw new Error('저장할 일정 데이터가 없습니다.');

                    const client = window.supabaseClient;
                    if (!client) throw new Error('DB 연결 오류');

                    // 1. Insert Trip
                    const { data: tripData, error: tripError } = await client
                        .from('trips')
                        .insert({
                            user_id: session.user.id,
                            title: itinerary.title || `${tripInfo.destinations[0]} 여행`,
                            destination: tripInfo.destinations.join(', '),
                            start_date: tripInfo.startDate,
                            end_date: tripInfo.endDate,
                            companion_type: tripInfo.companion === 'friends' ? 'friends' :
                                tripInfo.companion === 'couple' ? 'couple' :
                                    tripInfo.companion === 'family' ? 'family' : 'alone',
                            travel_style: tripInfo.styles,
                            // budget_level mapping needs to be handled if DB requires specific enum, assuming text for now or mapped previously
                            budget_level: 'mid' // Default or map from tripInfo if available
                        })
                        .select()
                        .single();

                    if (tripError) throw tripError;

                    const tripId = tripData.id;

                    // 2. Insert Days & Items
                    if (itinerary.days && itinerary.days.length > 0) {
                        for (const day of itinerary.days) {
                            // Insert Day
                            const { data: dayData, error: dayError } = await client
                                .from('trip_days')
                                .insert({
                                    trip_id: tripId,
                                    day_number: day.day,
                                    date: day.date,
                                    title: day.theme,
                                    summary: day.day_theme
                                })
                                .select()
                                .single();

                            if (dayError) throw dayError;

                            // Insert Items
                            if (day.schedule && day.schedule.length > 0) {
                                const itemsPayload = day.schedule.map(item => ({
                                    trip_day_id: dayData.id,
                                    place_name: item.place?.name_ko || item.place || item.activity, // Handle various formats
                                    category: item.category,
                                    description: item.description,
                                    address: item.place?.address || '',
                                    duration_minutes: 60, // Default or parse from item.duration
                                    image_url: '' // Future enhancement
                                }));

                                const { error: itemsError } = await client
                                    .from('trip_items')
                                    .insert(itemsPayload);

                                if (itemsError) throw itemsError;
                            }
                        }
                    }

                    saveBtn.textContent = '저장 완료!';
                    alert('일정이 성공적으로 저장되었습니다!');

                } catch (err) {
                    console.error('Save failed:', err);
                    alert('저장 실패: ' + err.message);
                    saveBtn.textContent = '저장하기';
                    saveBtn.disabled = false;
                }
            });
        });

        function renderItinerary(data) {
            const sidebarList = document.getElementById('daySidebarList');
            const mainContent = document.getElementById('itineraryContent');

            sidebarList.innerHTML = '';
            mainContent.innerHTML = '';

            if (data.tripTitle) {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'mb-8';
                titleDiv.innerHTML = `
                      <h1 class="text-3xl font-bold tracking-tight">${data.tripTitle || '나의 여행 일정'}</h1>
                      <p class="text-[#4c739a]">${data.summary || 'AI가 생성한 맞춤 여행 일정입니다.'}</p>
                  `;
                mainContent.appendChild(titleDiv);
            }

            if (Array.isArray(data.days)) {
                data.days.forEach((day, index) => {
                    // Sidebar Item
                    const sbItem = document.createElement('button');
                    sbItem.className = 'w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-primary/5 text-sm font-medium text-[#4c739a] text-left';
                    sbItem.innerHTML = `
                            <span class="material-symbols-outlined text-xl text-gray-400">calendar_today</span>
                            Day ${day.day}: ${day.theme || '일정'}
                       `;
                    sbItem.onclick = () => {
                        document.getElementById(`day-${day.day}`).scrollIntoView({ behavior: 'smooth' });
                    };
                    sidebarList.appendChild(sbItem);

                    // Main Content Section
                    const daySection = document.createElement('div');
                    daySection.id = `day-${day.day}`;
                    daySection.className = 'mb-12 relative pl-10';

                    // Timeline line
                    const line = document.createElement('div');
                    line.className = 'absolute left-[19px] top-4 bottom-4 w-0.5 bg-gradient-to-b from-primary via-primary/40 to-transparent';
                    daySection.appendChild(line);

                    // Day Header
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'mb-6 -ml-10';
                    dayHeader.innerHTML = `
                           <h2 class="text-2xl font-bold">Days ${day.day}</h2>
                           <p class="text-sm text-gray-500">${day.date || ''}</p>
                       `;
                    daySection.appendChild(dayHeader);

                    // Activities
                    if (Array.isArray(day.schedule)) {
                        day.schedule.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'relative pb-10 group';
                            card.innerHTML = `
                                    <div class="absolute -left-[31px] top-0 bg-white dark:bg-slate-800 border-2 border-primary size-6 rounded-full flex items-center justify-center z-10 transition-transform group-hover:scale-110">
                                         <div class="size-2 bg-primary rounded-full"></div>
                                    </div>
                                    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-[#e7edf3] dark:border-slate-800 overflow-hidden hover:shadow-md transition-shadow">
                                         <div class="flex flex-col sm:flex-row min-h-32">
                                              <!-- Image placeholder if available, otherwise icon -->
                                              <div class="w-full sm:w-1/3 bg-gray-100 dark:bg-gray-800 flex items-center justify-center p-4">
                                                   <span class="material-symbols-outlined text-4xl text-gray-300">
                                                       ${item.type === 'food' ? 'restaurant' : 'location_on'}
                                                   </span>
                                              </div>
                                              <div class="w-full sm:w-2/3 p-5 flex flex-col justify-between">
                                                   <div>
                                                       <div class="flex items-center justify-between mb-1">
                                                           <p class="text-xs font-bold text-primary tracking-widest uppercase">${item.time || '시간 미정'}</p>
                                                       </div>
                                                       <h3 class="text-xl font-bold mb-2">${item.place || item.activity}</h3>
                                                       <p class="text-sm text-[#4c739a] line-clamp-3 leading-relaxed">${item.description}</p>
                                                   </div>
                                              </div>
                                         </div>
                                    </div>
                                `;
                            daySection.appendChild(card);
                        });
                    }
                    mainContent.appendChild(daySection);
                });
            }
        }
    </script>
</body>

</html>